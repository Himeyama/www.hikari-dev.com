<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<link rel="stylesheet" href="/assets/css/styles.css">
<meta name="Hikari's personal website that is written information technology.">
<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Ubuntu 系の Linux ディストリビューションの自作方法 | ひかりの実験室</title>
<meta name="generator" content="Jekyll v4.3.2" />
<meta property="og:title" content="Ubuntu 系の Linux ディストリビューションの自作方法" />
<meta name="author" content="ひかり" />
<meta property="og:locale" content="ja_JP" />
<meta name="description" content="概要 iso ファイル (ディスクイメージ) を展開 squashfs ファイル (/ の中、ファイルシステムイメージ) を展開 (2.) で展開してものに対し、カスタマイズするためのスクリプトを適用 (3.) から squashfs を作成 (mksquashfs コマンド) (4.) を (1.) に入れて、チェックサムやファイルサイズ、パッケージのリストを更新 (5.) を iso ファイルを作成 (xorriso コマンドを使用)" />
<meta property="og:description" content="概要 iso ファイル (ディスクイメージ) を展開 squashfs ファイル (/ の中、ファイルシステムイメージ) を展開 (2.) で展開してものに対し、カスタマイズするためのスクリプトを適用 (3.) から squashfs を作成 (mksquashfs コマンド) (4.) を (1.) に入れて、チェックサムやファイルサイズ、パッケージのリストを更新 (5.) を iso ファイルを作成 (xorriso コマンドを使用)" />
<link rel="canonical" href="https://www.hikari-dev.com/2022/05/12/create-jisaku-dist.html" />
<meta property="og:url" content="https://www.hikari-dev.com/2022/05/12/create-jisaku-dist.html" />
<meta property="og:site_name" content="ひかりの実験室" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2022-05-12T00:00:00+00:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Ubuntu 系の Linux ディストリビューションの自作方法" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"ひかり"},"dateModified":"2022-05-12T00:00:00+00:00","datePublished":"2022-05-12T00:00:00+00:00","description":"概要 iso ファイル (ディスクイメージ) を展開 squashfs ファイル (/ の中、ファイルシステムイメージ) を展開 (2.) で展開してものに対し、カスタマイズするためのスクリプトを適用 (3.) から squashfs を作成 (mksquashfs コマンド) (4.) を (1.) に入れて、チェックサムやファイルサイズ、パッケージのリストを更新 (5.) を iso ファイルを作成 (xorriso コマンドを使用)","headline":"Ubuntu 系の Linux ディストリビューションの自作方法","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.hikari-dev.com/2022/05/12/create-jisaku-dist.html"},"url":"https://www.hikari-dev.com/2022/05/12/create-jisaku-dist.html"}</script>
<!-- End Jekyll SEO tag -->

<script src="/assets/js/wareki.js"></script>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-6QLJRW2VM8"></script>
<script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'G-6QLJRW2VM8');
</script>
<!-- <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9005833361216146"
    crossorigin="anonymous"></script>
<ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid"
    data-ad-client="ca-pub-9005833361216146" data-ad-slot="6901616621"></ins>
<script>
    (adsbygoogle = window.adsbygoogle || []).push({});
</script> -->
</head>

<body>
    <header>
        <div class="header-panel">
    <h1><a href="/">ひかりの実験室</a></h1>
    <menu class="menu-buttons">
        <a href="/" id="home-button"><button>ホーム</button></a>
        <a href="/archives" id="archive-button"><button>アーカイブ</button></a>
        <a href="/tags" id="tags-button"><button>タグ別</button></a>
    </menu>
</div>
    </header>
    <div class="wrap-margin">
        <main>
            <div class="articles">
                <article>
    <div class="page-navigation">
        
        <a class="prev" href="/2022/05/12/create-gem.html">
            <button class="button style-standard">
                前へ
            </button>
        </a>
        
        
        <a class="next" href="/2022/05/20/cublas.html">
            <button class="button style-standard">
                次へ
            </button>
        </a>
        
    </div>
</article>

<article>
    <h1 class="page-title">Ubuntu 系の Linux ディストリビューションの自作方法</h1>
    <time class="posted-date">2022-05-12</time>
    <div id="table-of-contents">
        <h2>目次</h2>
        
    </div>
    <div id="markdown-content">
        <h2 id="概要">概要</h2>
<ol>
  <li>iso ファイル (ディスクイメージ) を展開</li>
  <li>squashfs ファイル (<code class="language-plaintext highlighter-rouge">/</code> の中、ファイルシステムイメージ) を展開</li>
  <li>(2.) で展開してものに対し、カスタマイズするためのスクリプトを適用</li>
  <li>(3.) から squashfs を作成 (<code class="language-plaintext highlighter-rouge">mksquashfs</code> コマンド)</li>
  <li>(4.) を (1.) に入れて、チェックサムやファイルサイズ、パッケージのリストを更新</li>
  <li>(5.) を iso ファイルを作成 (<code class="language-plaintext highlighter-rouge">xorriso</code> コマンドを使用)</li>
</ol>

<p>この流れで、Ubuntu の改造ディストリビューションを作成できます。</p>

<h2 id="用意するもの">用意するもの</h2>
<ul>
  <li>Ubuntu のイメージ</li>
</ul>

<h2 id="必要なパッケージのインストール">必要なパッケージのインストール</h2>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt <span class="nb">install </span>cd-boot-images-amd64 xorriso
</code></pre></div></div>

<p>パッケージがないとかでインストールができない場合は以下を実行し再度実行してください。</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo</span> <span class="s2">"deb http://cz.archive.ubuntu.com/ubuntu jammy main"</span> | <span class="nb">sudo tee</span> <span class="nt">-a</span> /etc/apt/sources.list
<span class="nb">sudo </span>apt update
</code></pre></div></div>

<h2 id="展開とマウント">展開とマウント</h2>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># DISK_IMAGE はディスクイメージのパスです。</span>
<span class="nv">DISK_IMAGE</span><span class="o">=</span>/mnt/d/ubuntu-22.04-desktop-amd64.iso

<span class="c"># RELEASENOTE_URL はリリースノートの URL です。</span>
<span class="nv">RELEASENOTE_URL</span><span class="o">=</span><span class="s2">"http://"</span>

<span class="c"># 作業ディレクトリーの作成</span>
<span class="nb">mkdir</span> ~/my-distribution
<span class="nb">cd</span> ~/my-distribution

<span class="c"># ディスクイメージのシンボリックリンクを作成します。</span>
<span class="nb">ln</span> <span class="nt">-s</span> <span class="nv">$DISK_IMAGE</span> image.iso

<span class="c"># ディスクイメージをマウント</span>
<span class="c"># 警告が出ますが無視してください。</span>
<span class="nb">mkdir </span>mnt
<span class="nb">sudo </span>mount <span class="nt">-o</span> loop image.iso mnt

<span class="c"># ディスクイメージのコピー</span>
<span class="c"># マウントした場所は書き換えができないのでコピーします。</span>
<span class="c"># ただし、ディストリビューションのファイルシステムである /casper/filesystem.squashfs は除外してコピーします。</span>
<span class="nb">mkdir </span>disk
rsync <span class="nt">-P</span> <span class="nt">-a</span> <span class="nt">--exclude</span><span class="o">=</span>/casper/filesystem.squashfs mnt/ disk

<span class="c"># ファイルシステムイメージのマウント</span>
<span class="nb">mkdir </span>mntfs
<span class="nb">sudo </span>mount <span class="nt">-t</span> squashfs <span class="nt">-o</span> loop mnt/casper/filesystem.squashfs mntfs

<span class="c"># ファイルシステムをコピー</span>
<span class="c"># マウントした場所は書き換えできないので、コピーします。</span>
<span class="nb">mkdir </span>squashfs
<span class="nb">sudo </span>rsync <span class="nt">-P</span> <span class="nt">-a</span> mntfs/ squashfs

<span class="c"># マウントは不要になったのでアンマウントします。</span>
<span class="nb">sudo </span>umount mntfs
<span class="nb">sudo </span>umount mnt
<span class="nb">rm</span> <span class="nt">-r</span> mntfs mnt

<span class="c"># シンボリックリンクも不要なので削除します</span>
<span class="nb">rm </span>image.iso

<span class="c"># リリースノートの URL を設定します。</span>
<span class="nb">echo</span> <span class="nv">$RELEASENOTE_URL</span> | <span class="nb">sudo tee </span>disk/.disk/release_notes_url

<span class="c"># ディスク情報を設定します。</span>
<span class="nv">today</span><span class="o">=</span><span class="si">$(</span><span class="nb">date</span> +<span class="s2">"%Y%m%d"</span><span class="si">)</span>
<span class="nb">echo</span> <span class="nt">-n</span> <span class="s2">"MyDistribution 22.04 LTS </span><span class="se">\"</span><span class="s2">Jammy Jellyfish</span><span class="se">\"</span><span class="s2"> - Release amd64 (</span><span class="nv">$today</span><span class="s2">)"</span> | <span class="nb">tee 
echo</span> <span class="nt">-n</span> <span class="s2">"MyDistribution 22.04 LTS </span><span class="se">\"</span><span class="s2">Jammy Jellyfish</span><span class="se">\"</span><span class="s2"> - Release amd64 (</span><span class="nv">$today</span><span class="s2">)"</span> | <span class="nb">sudo tee </span>disk/.disk/info

<span class="c"># インストーラーの言語を日本語に設定します。</span>
<span class="nb">cat</span> | <span class="nb">sudo tee</span> <span class="nt">-a</span> disk/preseed/ubuntu.seed <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
d-i debian-installer/language string ja
d-i debian-installer/locale string ja_JP.UTF-8
d-i keyboard-configuration/layoutcode string jp
d-i keyboard-configuration/modelcode jp106
d-i keyboard-configuration/layout select Japanese
d-i keyboard-configuration/variant select Japanese
</span><span class="no">EOF

</span><span class="c"># grub.cfg の日本語化</span>
<span class="nv">splash</span><span class="o">=</span><span class="si">$(</span><span class="nb">echo</span> <span class="s2">"splash --- debian-installer/language=ja"</span> <span class="se">\</span>
<span class="s2">"debian-installer/locale=ja_JP.UTF-8"</span> <span class="se">\</span>
<span class="s2">"keyboard-configuration/layoutcode?=jp"</span> <span class="se">\</span>
<span class="s2">"keyboard-configuration/modelcode?=pc105"</span><span class="si">)</span>
<span class="nb">sudo sed</span> <span class="nt">-i</span> <span class="s2">"s#splash ---#</span><span class="nv">$splash</span><span class="s2">#"</span> disk/boot/grub/grub.cfg
</code></pre></div></div>

<h2 id="カスタマイズするためのスクリプトの割り当て">カスタマイズするためのスクリプトの割り当て</h2>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># MyDistribution.sh は Ubuntu をカスタマイズするスクリプトです。</span>
<span class="nb">chroot </span>squashfs /bin/bash MyDistribution.sh
</code></pre></div></div>

<h2 id="ファイルシステムの作成">ファイルシステムの作成</h2>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># パッケージ一覧を書き込み</span>
<span class="nb">sudo chroot </span>squashfs/ dpkg-query <span class="nt">-W</span> <span class="nt">--showformat</span><span class="o">=</span><span class="s1">'${binary:Package}\t${Version}\n'</span> |<span class="se">\</span>
<span class="nb">tee </span>disk/casper/filesystem.manifest

<span class="c"># ファイルシステムのサイズを書き込み</span>
<span class="nb">sudo du</span> <span class="nt">-B</span> 1 <span class="nt">-s</span> squashfs/ | <span class="nb">cut</span> <span class="nt">-f1</span> | <span class="nb">sudo tee </span>disk/casper/filesystem.size

<span class="c"># ファイルシステムのイメージ化</span>
<span class="nb">sudo </span>mksquashfs squashfs/ disk/casper/filesystem.squashfs <span class="nt">-xattrs</span> <span class="nt">-comp</span> xz
<span class="nb">sudo rm </span>disk/casper/filesystem.squashfs.gpg

<span class="c"># md5sum.txt を出力</span>
<span class="nb">cd </span>disk
find <span class="nb">.</span> <span class="nt">-type</span> f <span class="nt">-not</span> <span class="nt">-name</span> <span class="s1">'md5sum.txt'</span> <span class="nt">-not</span> <span class="nt">-path</span> <span class="s1">'./boot/*'</span> <span class="nt">-not</span> <span class="nt">-path</span> <span class="s1">'./EFI/*'</span> <span class="nt">-print0</span> | xargs <span class="nt">-0</span> <span class="nb">md5sum</span> | <span class="nb">sudo tee </span>md5sum.txt
<span class="nb">md5sum</span> ./boot/memtest86+.bin | <span class="nb">sudo tee</span> <span class="nt">-a</span> md5sum.txt
<span class="nb">md5sum</span> ./boot/grub/<span class="k">*</span>.cfg | <span class="nb">sudo tee</span> <span class="nt">-a</span> md5sum.txt
<span class="nb">cd</span> ..
</code></pre></div></div>

<h2 id="ディスクイメージの作成">ディスクイメージの作成</h2>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">VOLUME_ID</span><span class="o">=</span><span class="s2">"MyDistribution"</span>
<span class="nv">OUTPUT_ISO</span><span class="o">=</span><span class="s2">"mydistribution-22.04-desktop-amd64.iso"</span>

xorriso <span class="se">\</span>
    <span class="nt">-as</span> mkisofs  <span class="se">\</span>
    <span class="nt">-volid</span> <span class="s2">"</span><span class="nv">$VOLUME_ID</span><span class="s2">"</span> <span class="se">\</span>
    <span class="nt">-o</span> <span class="s2">"</span><span class="nv">$OUTPUT_ISO</span><span class="s2">"</span> <span class="se">\</span>
    <span class="nt">-J</span> <span class="nt">-joliet-long</span> <span class="nt">-l</span>  <span class="se">\</span>
    <span class="nt">-b</span> boot/grub/i386-pc/eltorito.img  <span class="se">\</span>
    <span class="nt">-no-emul-boot</span>  <span class="se">\</span>
    <span class="nt">-boot-load-size</span> 4  <span class="se">\</span>
    <span class="nt">-boot-info-table</span>  <span class="se">\</span>
    <span class="nt">--grub2-boot-info</span>  <span class="se">\</span>
    <span class="nt">--grub2-mbr</span> /usr/share/cd-boot-images-amd64/images/boot/grub/i386-pc/boot_hybrid.img <span class="se">\</span>
    <span class="nt">-append_partition</span> 2 0xef /usr/share/cd-boot-images-amd64/images/boot/grub/efi.img  <span class="se">\</span>
    <span class="nt">-appended_part_as_gpt</span>  <span class="se">\</span>
    <span class="nt">--mbr-force-bootable</span>  <span class="se">\</span>
    <span class="nt">-eltorito-alt-boot</span>  <span class="se">\</span>
    <span class="nt">-e</span> <span class="nt">--interval</span>:appended_partition_2:all::  <span class="se">\</span>
    <span class="nt">-no-emul-boot</span> <span class="se">\</span>
    <span class="nt">-partition_offset</span> 16 <span class="se">\</span>
    <span class="nt">-r</span> <span class="se">\</span>
    disk/
</code></pre></div></div>

<h2 id="qemu-で起動してみる">QEMU で起動してみる</h2>
<h3 id="qemu-をインストールしていない場合">QEMU をインストールしていない場合</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt <span class="nb">install</span> <span class="nt">-y</span> qemu-system-x86
</code></pre></div></div>

<h3 id="livecd-を起動する">LiveCD を起動する</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>qemu-system-x86_64 <span class="nt">-m</span> 4G <span class="nt">-cdrom</span> mydistribution-22.04-desktop-amd64.iso <span class="nt">-boot</span> d <span class="nt">--enable-kvm</span> <span class="nt">-usb</span> <span class="nt">-smp</span> 6
</code></pre></div></div>

<h3 id="仮想ディスクにインストールする場合">仮想ディスクにインストールする場合</h3>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>qemu-img create <span class="nt">-f</span> qcow2 disk.qcow2 32G
<span class="nb">sudo </span>qemu-system-x86_64 <span class="nt">-hda</span> disk.qcow2 <span class="nt">-m</span> 4G <span class="nt">-cdrom</span> mydistribution-22.04-desktop-amd64.iso <span class="nt">-boot</span> d <span class="nt">--enable-kvm</span> <span class="nt">-usb</span> <span class="nt">-smp</span> 6
</code></pre></div></div>

    </div>
</article>

<article>
    <div class="page-navigation">
        
        <a class="prev" href="/2022/05/12/create-gem.html">
            <button class="button style-standard">
                前へ
            </button>
        </a>
        
        
        <a class="next" href="/2022/05/20/cublas.html">
            <button class="button style-standard">
                次へ
            </button>
        </a>
        
    </div>
</article>
            </div>
            <div class="menu-wrapper">
                <menu>
                    <div class="page-title">
    <a href="/">ひかりの実験室</a>
</div>
<div class="profile"></div>
<nav class="sub-menu">
    <p class="description">
        メニュー
    </p>
    <ul>
        <li><a href="/archives">アーカイブ</a></li>
        <li><a href="/tags">タグ別</a></li>
    </ul>
</nav>
                </menu>
            </div>
        </main>
    </div>
    <footer>
        <div class="footer">
    <div class="footer-contents">
        <p>
            © 2023 Hikari
        </p>
        <p>
            ひかりの実験室の著作権はひかりに属します。
        </p>
    </div>
    <script>
        let postedDates = document.getElementsByClassName("posted-date");
        for (let i = 0; i < postedDates.length; i++) {
            let date = postedDates[i].innerText
            if (date != "") {
                let warekiDate = Wareki.date(date)
                postedDates[i].innerText = warekiDate;
            }
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/highlightjs-line-numbers.js/2.8.0/highlightjs-line-numbers.min.js"></script>
    <script>hljs.highlightAll(); hljs.initLineNumbersOnLoad();</script>
</div>
    </footer>
</body>

</html>